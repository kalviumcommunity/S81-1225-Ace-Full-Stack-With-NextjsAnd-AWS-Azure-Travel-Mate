// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS - Normalized lookup values
// ============================================

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

enum TripStatus {
  PLANNING
  UPCOMING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

// ============================================
// USER MODEL - Core user entity (1NF, 2NF, 3NF compliant)
// ============================================

model User {
  id            String    @id @default(uuid()) @db.Uuid
  email         String    @unique @db.VarChar(255)
  name          String    @db.VarChar(255)
  passwordHash  String?   @db.VarChar(255)
  avatarUrl     String?   @db.Text
  bio           String?   @db.Text
  role          UserRole  @default(USER)
  emailVerified Boolean   @default(false)
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  reviews       Review[]
  favorites     Favorite[]
  trips         Trip[]
  tripMembers   TripMember[]

  // Indexes for common queries
  @@index([email])
  @@index([role])
  @@index([createdAt])
  @@map("users")
}

// ============================================
// CATEGORY MODEL - Normalized category lookup table
// ============================================

model Category {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique @db.VarChar(100)
  slug        String   @unique @db.VarChar(100)
  description String?  @db.Text
  iconUrl     String?  @db.Text
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  places      Place[]

  @@index([slug])
  @@index([isActive])
  @@map("categories")
}

// ============================================
// PLACE MODEL - Travel destinations (3NF - category normalized)
// ============================================

model Place {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @db.VarChar(255)
  slug        String   @unique @db.VarChar(255)
  description String?  @db.Text
  address     String?  @db.VarChar(500)
  city        String?  @db.VarChar(100)
  country     String   @db.VarChar(100)
  latitude    Decimal? @db.Decimal(10, 8)
  longitude   Decimal? @db.Decimal(11, 8)
  imageUrl    String?  @db.Text
  rating      Decimal  @default(0) @db.Decimal(2, 1)
  reviewCount Int      @default(0)
  priceLevel  Int?     @db.SmallInt // 1-5 scale
  isActive    Boolean  @default(true)
  isFeatured  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Foreign Keys
  categoryId  String   @db.Uuid
  category    Category @relation(fields: [categoryId], references: [id])

  // Relations
  reviews     Review[]
  favorites   Favorite[]
  tripPlaces  TripPlace[]
  amenities   PlaceAmenity[]
  images      PlaceImage[]

  // Indexes for common queries
  @@index([slug])
  @@index([categoryId])
  @@index([country])
  @@index([city])
  @@index([rating])
  @@index([isFeatured])
  @@index([isActive])
  @@index([latitude, longitude])
  @@map("places")
}

// ============================================
// PLACE_IMAGE MODEL - Multiple images per place (1NF compliant)
// ============================================

model PlaceImage {
  id        String   @id @default(uuid()) @db.Uuid
  url       String   @db.Text
  altText   String?  @db.VarChar(255)
  isPrimary Boolean  @default(false)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  // Foreign Keys
  placeId   String   @db.Uuid
  place     Place    @relation(fields: [placeId], references: [id])

  @@index([placeId])
  @@map("place_images")
}

// ============================================
// AMENITY MODEL - Normalized amenities lookup table
// ============================================

model Amenity {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @unique @db.VarChar(100)
  icon      String?  @db.VarChar(50)
  createdAt DateTime @default(now())

  // Relations
  places    PlaceAmenity[]

  @@map("amenities")
}

// ============================================
// PLACE_AMENITY MODEL - Many-to-many junction table (2NF compliant)
// ============================================

model PlaceAmenity {
  id        String   @id @default(uuid()) @db.Uuid
  createdAt DateTime @default(now())

  // Foreign Keys
  placeId   String   @db.Uuid
  amenityId String   @db.Uuid
  place     Place    @relation(fields: [placeId], references: [id])
  amenity   Amenity  @relation(fields: [amenityId], references: [id])

  // Composite unique constraint
  @@unique([placeId, amenityId])
  @@index([placeId])
  @@index([amenityId])
  @@map("place_amenities")
}

// ============================================
// REVIEW MODEL - User reviews for places
// ============================================

model Review {
  id        String       @id @default(uuid()) @db.Uuid
  rating    Int          @db.SmallInt // 1-5 scale
  title     String?      @db.VarChar(255)
  comment   String?      @db.Text
  status    ReviewStatus @default(PENDING)
  visitDate DateTime?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  // Foreign Keys
  userId    String       @db.Uuid
  placeId   String       @db.Uuid
  user      User         @relation(fields: [userId], references: [id])
  place     Place        @relation(fields: [placeId], references: [id])

  // Composite unique constraint - one review per user per place
  @@unique([userId, placeId])
  @@index([userId])
  @@index([placeId])
  @@index([status])
  @@index([rating])
  @@index([createdAt])
  @@map("reviews")
}

// ============================================
// FAVORITE MODEL - User's saved/favorite places
// ============================================

model Favorite {
  id        String   @id @default(uuid()) @db.Uuid
  createdAt DateTime @default(now())

  // Foreign Keys
  userId    String   @db.Uuid
  placeId   String   @db.Uuid
  user      User     @relation(fields: [userId], references: [id])
  place     Place    @relation(fields: [placeId], references: [id])

  // Composite unique constraint
  @@unique([userId, placeId])
  @@index([userId])
  @@index([placeId])
  @@map("favorites")
}

// ============================================
// TRIP MODEL - User's planned trips
// ============================================

model Trip {
  id          String     @id @default(uuid()) @db.Uuid
  name        String     @db.VarChar(255)
  description String?    @db.Text
  startDate   DateTime?
  endDate     DateTime?
  budget      Decimal?   @db.Decimal(12, 2)
  currency    String     @default("USD") @db.VarChar(3)
  status      TripStatus @default(PLANNING)
  isPublic    Boolean    @default(false)
  coverImage  String?    @db.Text
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Foreign Keys - Trip owner
  userId      String     @db.Uuid
  user        User       @relation(fields: [userId], references: [id])

  // Relations
  tripPlaces  TripPlace[]
  tripMembers TripMember[]

  @@index([userId])
  @@index([status])
  @@index([startDate])
  @@index([isPublic])
  @@map("trips")
}

// ============================================
// TRIP_PLACE MODEL - Places in a trip (many-to-many with extra data)
// ============================================

model TripPlace {
  id          String    @id @default(uuid()) @db.Uuid
  visitOrder  Int       @default(0)
  visitDate   DateTime?
  duration    Int?      // Duration in minutes
  notes       String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Foreign Keys
  tripId      String    @db.Uuid
  placeId     String    @db.Uuid
  trip        Trip      @relation(fields: [tripId], references: [id])
  place       Place     @relation(fields: [placeId], references: [id])

  // Composite unique constraint
  @@unique([tripId, placeId])
  @@index([tripId])
  @@index([placeId])
  @@index([visitOrder])
  @@map("trip_places")
}

// ============================================
// TRIP_MEMBER MODEL - Collaborative trip planning
// ============================================

model TripMember {
  id        String   @id @default(uuid()) @db.Uuid
  role      String   @default("viewer") @db.VarChar(50) // owner, editor, viewer
  joinedAt  DateTime @default(now())

  // Foreign Keys
  tripId    String   @db.Uuid
  userId    String   @db.Uuid
  trip      Trip     @relation(fields: [tripId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  // Composite unique constraint
  @@unique([tripId, userId])
  @@index([tripId])
  @@index([userId])
  @@map("trip_members")
}
